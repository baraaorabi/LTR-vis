<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style type="text/css">
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
    <div id="overview-container"></div><br><br>
    <div id="detail-container"></div>
<script>
var width = 1200;
var allCanvases = [];
var syncing = false;
function syncOverview() {
  if (syncing) return;
  syncing = true;
  var selection = d3.event.selection;
  allCanvases.forEach(b => d3.brushX().move(b, selection));
  loadDetail(Math.max(selection[0]-10, 0), selection[1] - 10);
  syncing = false;
} 

d3.select(window).on("load.overview", function() {
  d3.json("alignments.json", function(reads) {
    var scale = null;
    var svg = d3.select("#overview-container").selectAll("svg").data(reads).enter().append("svg").attr("width", (width + 50)).attr("height", 40);
    var canvas = svg.append("g");
    allCanvases.push(canvas);
    canvas.selectAll(".del rect").data(function (read) {
        scale = d3.scaleLinear().domain([0, read.target_length]).range([0,width]); 
        return read.data.filter(function(d) { return d.type === "d"});
      }).enter().append("rect").attr("class", "del")
      .attr("fill", "gray")
      .attr("x", function(d) { return scale(d.start) + 30; })
      .attr("y", 28)
      .attr("width", function(d) { return scale(d.end) - scale(d.start)})
      .attr("height", 2);
    canvas.selectAll(".match rect").data(function (read) {
        return read.data.filter(function(d) { return d.type === "m"});
      }).enter().append("rect").attr("class", "match")
      .attr("fill", "green")
      .attr("x", function(d) { return scale(d.start) + 30; })
      .attr("y", 26)
      .attr("width", function(d) { return scale(d.end) - scale(d.start)})
      .attr("height", 6);
    canvas.selectAll(".ins rect").data(function (read) {
        return read.data.filter(function(d) { return d.type === "i"});
      }).enter().append("rect").attr("class", "ins")
      .attr("fill", "purple")
      .attr("x", function(d) { return scale(d.pos) + 30; })
      .attr("y", function(d) { return 26; })
      .attr("width", function(d) { return 2; })
      .attr("height", function(d) { return 10; });
    canvas.selectAll("ellipse").data(function (read) {
        return read.data.filter(function(d) { return d.type === "i"});
      }).enter().append("ellipse")
      .attr("stroke", "purple")
      .attr("fill", "white")
      .attr("cx", function(d) { return scale(d.pos) + 31; })
      .attr("cy", function(d) { return 15; })
      .attr("rx", function(d) { return 8; })
      .attr("ry", function(d) { return 12; });
    canvas.selectAll("text").data(function (read) {
        return read.data.filter(function(d) { return d.type === "i"});
      }).enter().append("text")
      .text(function(d) {return d.length; })
      .attr("font-family", "Arial")
      .attr("font-size", "8px")
      .attr("fill", "black")
      .style("text-anchor", "middle")
      .attr("x", function(d) { return scale(d.pos) + 31; })
      .attr("y", function(d) { return 18; });
    
    canvas.attr("class", "brush").call(d3.brushX().on("start brush", syncOverview));
     //canvas.append("rect").attr("x", scale(650)).attr("y", 0).attr("width", scale(150)).attr("height", 80).attr("fill", "rgba(128, 128, 128, 0.5)").attr("stroke", "rgba(128, 128, 128, 0.8)");
  });
});

function loadDetail(min, max) {
  d3.json("gene.json", function(gene) {
    var scale = null;
    d3.select("#detail-container").select("*").remove();
    var canvas = d3.select("#detail-container").append("svg").attr("width", width + 50).attr("height", 150);
    canvas.selectAll("rect").data(function () {
        scale = d3.scaleLinear().domain([0, (max - min)]).range([0,width]); 
        return gene.seq.filter(function(d, i) { return i >= min && i < max});
      }).enter().append("rect")
      .attr("fill", function(d) {
        if (d == 0)
          return "green";
        else if (d == 1)
          return "darkblue";
        else if (d == 2)
          return "yellow";
        else 
          return "red";
      })
      .attr("x", function(d,i) { return scale(i) + 30; })
      .attr("y", function(d) {
        return 12;
      })
      .attr("width", function(d,i) { return scale(i + 1) - scale(i)})
      .attr("height", function(d) {
        return 80;
      });
    canvas.selectAll("text").data(function (read) {
        return gene.seq.filter(function(d, i) { return i >= min && i < max});
      }).enter().append("text")
      .text(function(d) { 
        if ((max - min) > (width/6)) return "";
        if (d == 0)
          return "A";
        else if (d == 1)
          return "C";
        else if (d == 2)
          return "G";
        else 
          return "T";
      })
      .attr("font-family", "Arial")
      .attr("font-size", "8px")
      .attr("fill", "black")
      .style("text-anchor", "middle")
      .attr("x", function(d,i) { return scale(i) + 30 + (scale(i + 1) - scale(i))/2; })
      .attr("y", function(d) { return 10; });
    canvas.append("g").call(d3.axisBottom().scale(d3.scaleLinear().domain([min, max]).range([0,width]))).attr("transform", "translate(30, 95)");
    canvas.append("g").call(d3.axisLeft().scale(d3.scaleLinear().domain([0, 16]).range([0,80]))).attr("transform", "translate(27, 12)");
  });
}
</script>
</body>
</html>