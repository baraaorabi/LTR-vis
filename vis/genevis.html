<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style type="text/css">
  input[type='checkbox'] {
    height:25px;
    width:15px;
    margin:0px;
    margin-top:16px;
    vertical-align: top;
  }
  div {
    margin:1px;
  }
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
    <div style="margin:auto; width:100%" id="overview-container"></div><br>
    <div style="margin:auto; width:100%" id="detail-container"></div>
<script>
var width = 1400;
var allCanvases = [];
var syncing = false;
var lastSelection = null;

function syncOverview() {
  if (syncing) return;
  syncing = true;
  var selection = d3.event.selection;
  lastSelection = selection;
  allCanvases.forEach(b => d3.brushX().move(b, selection));
  if (selection != null && selection[1]-selection[0] > 0)
    loadDetail(Math.max(selection[0]-30, 0), selection[1] - 30);
  else 
    d3.select("#detail-container").select("*").remove();
  syncing = false;
} 

d3.select(window).on("load.overview", function() {
  d3.json("reads-to-gene.json", function(data) {
    var reads = data.queries;
    var scale = d3.scaleLinear().domain([0, data.target.length]).range([0,width]);
    var div = d3.select("#overview-container").selectAll("div").data(reads).enter().append("div").attr("id", function (d) { return d.name; });
    div.append("input").attr("type", "checkbox").attr("onclick", "updateDetail();");
    var canvas = div.append("svg").attr("width", (width + 50)).attr("height", 45).append("g");
    allCanvases.push(canvas);
    canvas.selectAll(".del rect").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "d"});
      }).enter().append("rect").attr("class", "del")
      .attr("fill", "gray")
      .attr("x", function(d) { return scale(d.start) + 30; })
      .attr("y", 28)
      .attr("width", function(d) { return scale(d.size)})
      .attr("height", 2);
    canvas.selectAll(".match rect").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "m"});
      }).enter().append("rect").attr("class", "match")
      .attr("fill", "green")
      .attr("x", function(d) { return scale(d.start) + 30; })
      .attr("y", 26)
      .attr("width", function(d) { return scale(d.size)})
      .attr("height", 6);
    canvas.selectAll(".ins rect").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "i"});
      }).enter().append("rect").attr("class", "ins")
      .attr("fill", "purple")
      .attr("x", function(d) { return scale(d.start) + 30; })
      .attr("y", function(d) { return 26; })
      .attr("width", function(d) { return 1; })
      .attr("height", function(d) { return 10; });
    canvas.selectAll("ellipse").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "i"});
      }).enter().append("ellipse")
      .attr("stroke", "purple")
      .attr("fill", "white")
      .attr("cx", function(d) { return scale(d.start) + 31; })
      .attr("cy", function(d) { return 14; })
      .attr("rx", function(d) { return 10; })
      .attr("ry", function(d) { return 12; });
    canvas.selectAll("text").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "i"});
      }).enter().append("text")
      .text(function(d) {return d.size; })
      .attr("font-family", "sans-serif")
      .attr("font-size", "10px")
      .attr("fill", "black")
      .style("text-anchor", "middle")
      .attr("x", function(d) { return scale(d.start) + 31; })
      .attr("y", function(d) { return 18; });
    canvas.append("text").text(function (read) {
      return read.name;
    })
    .attr("font-family", "sans-serif")
    .attr("font-size", "10px")
    .attr("fill", "gray")
    .style("text-anchor", "left")
    .attr("x", 30)
    .attr("y", 44)
    canvas.attr("class", "brush").call(d3.brushX().on("start brush", syncOverview));
  });
});

function updateDetail() {
  loadDetail(Math.max(lastSelection[0]-10, 0), lastSelection[1] - 10);
}

function loadDetail(min, max) {
  d3.json("reads-to-gene.json", function(data) {
    renderDetail(data.target, min, max);
    d3.selectAll("input")
    .each(function(d,i) {
      var readID = this.parentNode.id;
      if (this.checked) {
        read = data.queries.find(r => r.name == readID);
        renderDetail(read, min, max);
      }
      else {
        div = d3.select("#data-" + readID).select("*").remove();
      }
  })});
}

function renderDetail(data, min, max) {
  var xscale = d3.scaleLinear().domain([0, (max - min)]).range([0,width+15]);
  var yscale = d3.scaleLinear().domain([0, 42]).range([0,68]);
  var div = null
  if (d3.select("#data-" + data.name).size() > 0) {
    div = d3.select("#data-" + data.name)
    div.select("*").remove();
  }
  else {
    div = d3.select("#detail-container").append("div").attr("id", "data-" + data.name);
  }
  var canvas = div.append("svg").attr("width", width + 65).attr("height", 150);
  canvas.selectAll("rect").data(function () {
      return data.seq.filter(function(d, i) { return i >= min && i < max});
    }).enter().append("rect")
    .attr("fill", function(d) {
      if (d == 1)
        return "green";
      else if (d == 2)
        return "darkblue";
      else if (d == 3)
        return "yellow";
      else if (d == 4)
        return "red";
      else
        return "white";
    })
    .attr("x", function(d,i) { return xscale(i) + 30; })
    .attr("y", function(d) {
      return 25;
    })
    .attr("width", function(d,i) { return xscale(i + 1) - xscale(i)})
    .attr("height", function(d,i) {
      return Math.max(5,yscale(data.qual[min+i]));
    });
  canvas.selectAll("text").data(function (read) {
      return data.seq.filter(function(d, i) { return i >= min && i < max});
    }).enter().append("text")
    .text(function(d) { 
      if ((max - min) > (width/6)) return "";
      if (d == 1)
        return "A";
      else if (d == 2)
        return "C";
      else if (d == 3)
        return "G";
      else if (d == 4)
        return "T";
      else
        return "";
    })
    .attr("font-family", "sans-serif")
    .attr("font-size", "10px")
    .attr("fill", "black")
    .style("text-anchor", "middle")
    .attr("x", function(d,i) { return xscale(i) + 30 + (xscale(i + 1) - xscale(i))/2; })
    .attr("y", 23);
  canvas.append("text").text(data.name)
    .attr("font-family", "sans-serif")
    .attr("font-size", "10px")
    .attr("fill", "black")
    .style("text-anchor", "left")
    .attr("x", 30)
    .attr("y", 10)
  canvas.append("g").call(d3.axisBottom().scale(d3.scaleLinear().domain([min, max]).range([0,width+15]))).attr("transform", "translate(30, 95)");
  canvas.append("g").call(d3.axisLeft().scale(d3.scaleLinear().domain([0, 42]).range([0,68])).tickValues([0,6,12,18,24,30,36,42])).attr("transform", "translate(27, 24)");
}
</script>
</body>
</html>