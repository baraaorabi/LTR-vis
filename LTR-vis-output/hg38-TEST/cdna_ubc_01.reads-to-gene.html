<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style type="text/css">
  input[type='checkbox'] {
    width:18px;
    margin:0px;
    margin-right:5px;
    margin-top:10px;
    vertical-align: top;
  }
  div {
    margin:1px;
  }
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/d3fc/build/d3fc.min.js"></script>
</head>
<body onkeydown="deleteRange(event);" onload="loadOverview();">
    <div style="margin:auto; width:100%" id="overview-container"></div>
    <div style="margin:auto; margin-left:22px; width:100%" id="detail-container"></div>
<script>
var width = 1300;
var targetLength = 0;
var allCanvases = [];
var syncing = false;
var lastSelection = null;
var deletedRanges = [];

function syncOverview() {
  if (syncing) return;
  syncing = true;
  var selection = d3.event.selection;
  lastSelection = selection;
  allCanvases.forEach(b => d3.brushX().move(b, selection));
  if (selection != null && selection[1]-selection[0] > 0)
    loadDetail(selection[0], selection[1]);
  else
    d3.select("#detail-container").selectAll("*").remove();
  syncing = false;
}

function deleteRange(event) {
  if (event.keyCode == 8 || event.keyCode == 46) {
    if (event.shiftKey) {
      deletedRanges = [];
    }
    else {
      if (event.altKey) {
        var currentRange = currentRangeFromSelection(lastSelection);
        deletedRanges = deletedRanges.filter(r => r[0] >= currentRange[0] && r[1] <= currentRange[1]);
        deletedRanges.push([0, currentRange[0]]);
        deletedRanges.push([currentRange[1], targetLength]);
      }
      else {
        var currentRange = currentRangeFromSelection(lastSelection);
        deletedRanges = deletedRanges.filter(r => (r[1] <= currentRange[0] || r[0] >= currentRange[1]));
        deletedRanges.push(currentRange);
      }
    }
    allCanvases.forEach(b => d3.brushX().move(b, null));
    lastSelection = null;
    d3.select("#overview-container").selectAll("*").remove();
    loadOverview();
  }
}

function currentRangeFromSelection(selection) {
  // It turns out that .invert for D3FX's discontinuous scale is broken, so here we do the manual math for that
  // High-level summary: Compute the remaining domain size after all deleted ranges, map pixels to that space, then add offsets
  var remainingDomainSize = targetLength - deletedRanges.map(r => r[1] - r[0]).reduce((a,b) => a + b, 0);
  var scale = d3.scaleLinear().domain([0, remainingDomainSize]).range([0,width]);
  var rawDomainRange = [Math.floor(scale.invert(Math.min(width,Math.max(0,selection[0]-30)))), Math.ceil(scale.invert(Math.min(width,Math.max(0,selection[1]-30))))];
  var startOffset = 0;
  var endOffset = 0;
  deletedRanges.forEach(function (r) {
    var rangeOffset = r[0] - deletedRanges.filter(r2 => r2[1] <= r[0]).map(r2 => r2[1] - r2[0]).reduce((a,b) => a + b, 0);
    if (rangeOffset <= rawDomainRange[0]) {
      startOffset += r[1] - r[0];
    }
    if (rangeOffset <= rawDomainRange[1]) {
      endOffset += r[1] - r[0];
    }
  });

  return [rawDomainRange[0] + startOffset, rawDomainRange[1] + endOffset];
}

function currentLength() {
  var length = 0;
  for (i = 0; i < targetLength; i++) {
    if (!deletedRanges.some(r => r[0] <= i && r[1] >= i))
      length++;
  }
  return length;
}

function processInterval(interval) {
  var start = 0;
  var end = 0;
  var size = 0;
  for (i = 0; i <= interval.end; i++) {
      if (!deletedRanges.some(r => r[0] <= i && r[1] >= i)) {
        end++;
        if (i < interval.start)
          start++;
      }
    }
  if (interval.type == "i" || interval.type == "p" || interval.type == "s") {
    if (!deletedRanges.some(r => r[0] <= interval.start && r[1] >= interval.start))
      size = interval.size;
  }
  else {
    size = end - start;
  }

  var newInterval = {};
  newInterval.start = start;
  newInterval.end = end;
  newInterval.size = size;
  newInterval.score = interval.score;
  return newInterval;
}

function loadOverview() {
    targetLength = data.target.length
    var reads = data.queries.sort(function (a,b) { return a.name.localeCompare(b.name); });
    var length = currentLength();
    var scale = d3.scaleLinear().domain([0, length]).range([0,width]);
    var xscale = fc.scaleDiscontinuous(d3.scaleLinear())
    .discontinuityProvider(fc.discontinuityRange.apply(this, deletedRanges))
    .domain([0, targetLength]).range([0,width]);
    var referenceDiv = d3.select("#overview-container").append("div").attr("class", "reference").style("margin", "-6px").style("margin-left", "17px");
    var referenceCanvas = referenceDiv.append().append("svg").attr("width", (width + 60)).attr("height", 34).append("g");
    allCanvases.push(referenceCanvas);
    referenceCanvas.append("rect")
      .attr("fill", "black")
      .attr("x", 30)
      .attr("y", 12)
      .attr("width", width)
      .attr("height", 8);
    referenceCanvas.append("text").text(data.target.name)
    .attr("font-family", "sans-serif")
    .attr("font-size", "10px")
    .attr("fill", "black")
    .style("text-anchor", "left")
    .attr("x", 30)
    .attr("y", 29);
    referenceCanvas.attr("class", "brush").call(d3.brushX().on("start brush", syncOverview));

    var div = d3.select("#overview-container").selectAll(".read div").data(reads).enter().append("div").attr("class", "read").style("margin", "-6px").attr("id", function (d) { return d.name; });
    div.append("input").attr("type", "checkbox").attr("id", function (d) { return d.name + "-box"; }).attr("onclick", "updateDetail();");
    var canvas = div.append("svg").attr("width", (width + 60)).attr("height", 34).append("g");
    allCanvases.push(canvas);
    canvas.selectAll(".del rect").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "d"}).map(i => processInterval(i)).filter(d => d.size > 0);
      }).enter().append("rect").attr("class", "del")
      .attr("fill", "gray")
      .attr("x", function(d) { return scale(d.start) + 30; })
      .attr("y", 15)
      .attr("width", function(d) { return scale(d.size)})
      .attr("height", 2);
    canvas.selectAll(".match rect").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "m"}).map(i => processInterval(i)).filter(d => d.size > 0);
      }).enter().append("rect").attr("class", "match")
      .attr("fill", function (d) {
        if (d.score == 0)
          return "darkred";
        if (d.score == 1)
          return "coral";
        if (d.score == 2)
          return "gold";
        if (d.score == 3)
          return "lawngreen";
        if (d.score == 4)
          return "green";
        if (d.score == 5)
          return "darkgreen";
        else {
          return "black";
        }
      })
      .attr("x", function(d) { return scale(d.start) + 30; })
      .attr("y", 12)
      .attr("width", function(d) { return scale(d.size)})
      .attr("height", 8);
    canvas.selectAll(".cut rect").data(deletedRanges.map(function (r) {
      var interval = {};
      interval.start = r[0];
      interval.end = r[1];
      return processInterval(interval);
    })).enter().append("rect").attr("class", "cut")
      .attr("fill", "black")
      .attr("x", function(d) { return scale(d.start) + 30; })
      .attr("y", function(d) { return 0; })
      .attr("width", function(d) { return 2; })
      .attr("height", function(d) { return 34; });

    canvas.selectAll(".prefix rect").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "p"}).map(i => processInterval(i)).filter(d => d.size > 0);
      }).enter().append("rect").attr("class", "prefix")
      .attr("fill", "gray")
      .attr("x", function(d) { 
        if (scale(d.start) - scale(d.size) < 0)
          return 24;
        else
          return scale(d.start) + 30 - scale(d.size);
      })
      .attr("y", function(d) { return 3; })
      .attr("width", function(d) { 
        if (scale(d.start) - scale(d.size) < 0) 
          return scale(d.start) + 6;
        else 
          return scale(d.size);
      })
      .attr("height", function(d) { return 8; });
    canvas.selectAll(".suffix rect").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "s"}).map(i => processInterval(i)).filter(d => d.size > 0);
      }).enter().append("rect").attr("class", "suffix")
      .attr("fill", "gray")
      .attr("x", function(d) { return scale(d.start) + 30 })
      .attr("y", function(d) { return 3; })
      .attr("width", function(d) { 
        if (scale(d.start) + scale(d.size) > width) {
          return width - scale(d.start) + 6;
        }
        else
          return scale(d.size);
      })
      .attr("height", function(d) { return 8; });
    canvas.selectAll(".insert rect").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "i"}).map(i => processInterval(i)).filter(d => d.size > 0);
      }).enter().append("rect").attr("class", "insert")
      .attr("fill", "gray")
      .attr("x", function(d) { return scale(d.start) + 30 - (scale(d.size)/2) })
      .attr("y", function(d) { return 3; })
      .attr("width", function(d) { return scale(d.size)})
      .attr("height", function(d) { return 8; });
    canvas.selectAll(".imarker polygon").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "i"}).map(i => processInterval(i)).filter(d => d.size > 0);
      }).enter().append("polygon").attr("class", "marker")
      .attr("fill", "gray")
      .attr("points", function(d) { return (scale(d.start) + 26).toString() + ",3 " + (scale(d.start) + 34).toString() + ",3 " + (scale(d.start) + 30).toString() + ",21 "; });
    canvas.selectAll(".pmarker polygon").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "p"}).map(i => processInterval(i)).filter(d => d.size > 0);
      }).enter().append("polygon").attr("class", "marker")
      .attr("fill", "gray")
      .attr("points", function(d) { return (scale(d.start) + 25).toString() + ",3 " + (scale(d.start) + 30).toString() + ",3 " + (scale(d.start) + 30).toString() + ",21 "; });
    canvas.selectAll(".smarker polygon").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "s"}).map(i => processInterval(i)).filter(d => d.size > 0);
      }).enter().append("polygon").attr("class", "marker")
      .attr("fill", "gray")
      .attr("points", function(d) { return (scale(d.start) + 30).toString() + ",3 " + (scale(d.start) + 35).toString() + ",3 " + (scale(d.start) + 30).toString() + ",21 "; });
    canvas.selectAll(".prefixcut text").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "p"}).map(i => processInterval(i)).filter(d => scale(d.start) - scale(d.size) < 0);
      }).enter().append("text")
      .text(function(d) {return (Math.ceil((scale(d.size) - scale(d.start))/scale(d.size)*d.size)).toString() + ".."; })
      .attr("font-family", "sans-serif")
      .attr("font-size", "10px")
      .attr("fill", "gray")
      .style("text-anchor", "right")
      .attr("x", function(d) { return 2; })
      .attr("y", function(d) { return 11; });
    canvas.selectAll(".suffixcut text").data(function (read) {
        return read.intervals.filter(function(d) { return d.type === "s"}).map(i => processInterval(i)).filter(d => scale(d.start) + scale(d.size) > width);
      }).enter().append("text")
      .text(function(d) {return ".." + (Math.ceil((scale(d.start) + scale(d.size) - width)/scale(d.size)*d.size)).toString(); })
      .attr("font-family", "sans-serif")
      .attr("font-size", "10px")
      .attr("fill", "gray")
      .style("text-anchor", "right")
      .attr("x", function(d) { return width + 36; })
      .attr("y", function(d) { return 11; });
    canvas.append("text").text(function (read) {
      return read.name;
    })
    .attr("font-family", "sans-serif")
    .attr("font-size", "10px")
    .attr("fill", "black")
    .style("text-anchor", "left")
    .attr("x", 30)
    .attr("y", 29);

    canvas.attr("class", "brush").call(d3.brushX().on("start brush", syncOverview));
    d3.select("#overview-container").append("div").append("svg").attr("width", (width + 60)).attr("height", 23).append("g").call(d3.axisBottom().scale(xscale).tickFormat(d3.format('.0f'))).attr("transform", "translate(46, 3)");
  ;
}

function updateDetail() {
  loadDetail(lastSelection[0], lastSelection[1]);
}

function loadDetail(minSelection, maxSelection) {
    var dataRange = currentRangeFromSelection([minSelection, maxSelection]);
    if (d3.select("#data-" + data.target.name).size() == 0) {
        d3.select("#detail-container").append("div").attr("id", "data-" + data.target.name);
    }
    renderDetail(data.target, null, dataRange[0], dataRange[1]);
    var boxes = [];
    d3.selectAll("input").each(d => boxes.push(d));
    boxes.sort(function (a,b) { return a.name.localeCompare(b.name); });
    boxes.forEach(function(d) {
      if (d3.select("#data-" + d.name).size() == 0) {
        d3.select("#detail-container").append("div").attr("id", "data-" + d.name);
      }
      if (document.getElementById(d.name + "-box").checked) {
        read = data.queries.find(r => r.name == d.name);
        renderDetail(read, data.target, dataRange[0], dataRange[1]);
      }
      else {
        d3.select("#data-" + d.name).select("*").remove();
      }
  });
}

function renderDetail(data, target, min, max) {
  var filteredData =  data.seq.filter(function(d, i) {
    return i >= min && i < max && !deletedRanges.some(r => r[0] <= i && r[1] >= i)
  });
  var filteredTarget = (target == null) ? null : target.seq.filter(function(d, i) {
    return i >= min && i < max && !deletedRanges.some(r => r[0] <= i && r[1] >= i)
  });
  var filteredQual =  data.qual.filter(function(d, i) {
    return i >= min && i < max && !deletedRanges.some(r => r[0] <= i && r[1] >= i)
  });
  var dataScale = d3.scaleLinear().domain([0, filteredData.length]).range([0,width]);
  var xscale = fc.scaleDiscontinuous(d3.scaleLinear())
    .discontinuityProvider(fc.discontinuityRange.apply(this, deletedRanges))
    .domain([min, max]).range([0,width]);
  var yscale = d3.scaleLinear().domain([0, 12]).range([0,50]);
  var div = d3.select("#data-" + data.name);
  div.select("*").remove();

  var canvas = div.append("svg").attr("width", width + 65).attr("height", 85);
  canvas.selectAll(".base rect").data(filteredData).enter().append("rect").attr("class", "base")
    .attr("fill", function(d,i) {
      if (target != null && filteredTarget[i] == d)
        return "gray";
      else if (d == 1)
        return "green";
      else if (d == 2)
        return "darkblue";
      else if (d == 3)
        return "yellow";
      else if (d == 4)
        return "red";
      else
        return "white";
    })
    .attr("x", function(d,i) { return dataScale(i) + 30; })
    .attr("y", function(d,i) {
      return 14 + 50 - yscale(Math.min(12,filteredQual[i]));
    })
    .attr("width", function(d,i) { return dataScale(i+1) - dataScale(i)})
    .attr("height", function(d,i) {
      return yscale(Math.min(12,filteredQual[i]));
    });
  canvas.selectAll(".cut rect").data(deletedRanges.filter(r => r[0] >= min && r[1] <= max)).enter().append("rect").attr("class", "cut")
      .attr("fill", "black")
      .attr("x", function(d) { return xscale(d[0]) + 30 - 2; })
      .attr("y", function(d) { return 2; })
      .attr("width", function(d) { return 3; })
      .attr("height", function(d) { return 75; });
  canvas.selectAll("text").data(filteredData).enter().append("text")
    .text(function(d,i) {
      if (filteredData.length > (width/6))
        return ""
      if (d == 1)
        return "A";
      else if (d == 2)
        return "C";
      else if (d == 3)
        return "G";
      else if (d == 4)
        return "T";
      else
        return "";
    })
    .attr("font-family", "sans-serif")
    .attr("font-size", "10px")
    .attr("fill", "black")
    .style("text-anchor", "middle")
    .attr("x", function(d,i) { return dataScale(i) + 30 + (dataScale(i + 1) - dataScale(i))/2; })
    .attr("y", 13);
  var text = canvas.append("text").attr("class", "name").text(data.name)
    .attr("font-family", "sans-serif")
    .attr("font-size", "10px")
    .attr("fill", "black")
    .style("text-anchor", "left")
    .attr("x", 30)
    .attr("y", 61);
  var bbox = text.node().getBBox();
  canvas.append("rect")
    .attr("x", bbox.x)
    .attr("y", bbox.y)
    .attr("width", bbox.width)
    .attr("height", bbox.height)
    .style("fill-opacity", ".8")
    .style("fill", "#fff");
  text.raise();

  canvas.append("g").call(d3.axisBottom().scale(xscale).tickFormat(d3.format('.0f'))).attr("transform", "translate(30, 65)");
  canvas.append("g").call(d3.axisLeft().scale(d3.scaleLinear().domain([12, 0]).range([0,50])).tickFormat(d3.format('.0f')).tickValues([0,3,6,9,12])).attr("transform", "translate(28, 14)");
}

var data =
{"target":{"name":"ENSG00000111111","length":91,"seq":[1,1,4,4,2,2,3,3,1,1,4,4,2,2,3,3,1,2,4,3,1,4,2,3,1,4,3,4,1,1,4,4,4,4,4,2,3,2,3,3,2,1,4,4,1,1,1,4,3,3,4,4,4,1,4,4,1,3,2,3,4,1,4,1,1,3,2,4,1,1,1,3,3,3,4,2,4,4,2,2,1,1,4,1,4,1,2,3,4,1,3],"qual":[12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12]},"queries":[{"name":"READ1","seq":[1,1,4,4,2,2,3,3,1,1,4,4,2,2,3,3,1,2,4,3,1,4,2,3,1,4,3,4,1,1,4,4,4,4,4,2,3,2,3,3,2,1,4,4,1,1,1,4,3,3,4,4,4,1,4,4,1,3,2,3,4,1,4,1,1,3,2,4,1,1,1,3,3,3,4,2,4,4,2,2,1,1,4,1,4,1,2,3,4,1,3],"qual":[12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12],"intervals":[{"score":5,"orientation":"+","type":"m","size":91,"start":0,"end":90}]},{"name":"READ2","seq":[1,1,4,4,2,2,3,3,1,1,4,4,2,2,3,3,1,2,4,3,1,4,2,3,1,4,3,4,1,1,4,4,4,4,0,0,0,0,0,0,2,1,4,4,1,1,1,4,3,3,4,4,4,1,4,4,1,3,2,3,4,1,4,1,1,3,2,4,1,1,1,3,3,3,4,2,4,4,2,2,1,1,4,1,4,1,2,3,4,1,3],"qual":[12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,0,0,0,0,0,0,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12],"intervals":[{"score":5,"orientation":"+","type":"m","size":91,"start":0,"end":90}]},{"name":"READ3","seq":[1,1,4,4,2,2,3,3,1,1,4,4,2,2,3,3,1,2,4,3,1,4,2,3,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1,4,4,1,3,2,3,4,1,4,1,1,3,2,4,1,1,1,3,3,3,4,2,4,4,2,2,1,1,4,1,4,1,2,3,4,1,3],"qual":[12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12],"intervals":[{"score":5,"orientation":"+","type":"m","size":25,"start":0,"end":24},{"score":0,"orientation":"+","type":"d","size":26,"start":25,"end":50},{"score":0,"orientation":"+","type":"p","size":13,"start":51,"end":51,"qstart":25,"qend":37},{"score":5,"orientation":"+","type":"m","size":40,"start":51,"end":90}]},{"name":"READ4","seq":[0,0,0,0,0,0,3,3,1,1,4,4,2,2,3,3,1,2,4,3,1,4,2,3,1,4,3,4,1,1,4,4,4,4,4,2,3,2,3,3,2,1,4,4,1,1,1,4,3,3,4,4,4,1,4,4,1,3,2,3,4,1,4,1,1,3,2,4,1,1,1,3,3,3,4,2,4,4,2,2,0,0,0,0,0,0,0,0,0,0,0],"qual":[0,0,0,0,0,0,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,0,0,0,0,0,0,0,0,0,0,0],"intervals":[{"score":0,"orientation":"+","type":"d","size":6,"start":0,"end":5},{"score":5,"orientation":"+","type":"m","size":74,"start":6,"end":79},{"score":0,"orientation":"+","type":"d","size":11,"start":80,"end":90}]},{"name":"READ5","seq":[0,0,0,0,0,2,3,3,2,1,4,4,2,2,3,3,1,2,4,3,1,4,2,3,1,4,3,4,1,1,4,4,4,4,4,2,3,2,3,3,2,1,4,4,1,1,1,4,3,3,4,4,4,1,4,4,1,3,2,3,4,1,4,1,1,3,2,4,1,1,1,3,3,3,4,2,4,4,2,2,1,1,4,1,4,1,2,3,4,1,3],"qual":[0,0,0,0,0,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12],"intervals":[{"score":0,"orientation":"+","type":"d","size":5,"start":0,"end":4},{"score":0,"orientation":"+","type":"p","size":3,"start":5,"end":5,"qstart":0,"qend":2},{"score":5,"orientation":"+","type":"m","size":43,"start":5,"end":47},{"score":0,"orientation":"+","type":"i","size":22,"start":48,"end":48,"qstart":46,"qend":67},{"score":5,"orientation":"+","type":"m","size":43,"start":48,"end":90},{"score":0,"orientation":"+","type":"s","size":28,"start":91,"end":91,"qstart":111,"qend":138}]}]}
</script>
</body>
</html>
